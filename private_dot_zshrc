# # Executes commands at the start of an interactive session.
#
# Authors:
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#

# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# Customize to your needs...
export PATH=$PATH:~/bin


if [ -f "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
  source "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi

test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

# https://unix.stackexchange.com/questions/273861/unlimited-history-in-zsh
HISTFILE=~/.zsh_history
HISTSIZE=999999999
SAVEHIST=$HISTSIZE


### ALIASES ###


alias gs="git status"
alias gcmainpull='git fetch; git checkout $(git symbolic-ref refs/remotes/origin/HEAD | sed "s@^refs/remotes/origin/@@" ); git pull upstream $(git symbolic-ref refs/remotes/origin/HEAD | sed "s@^refs/remotes/origin/@@" )'
alias gst="git status -sb"
alias gl="git log"
alias ga="git add"
alias gaa="git add -A"
alias gal="git add ."
alias gall="git add ."
alias gca="git commit -a"
alias gc="git commit -m"
alias gcot="git checkout"
alias gchekout="git checkout"
alias gchckout="git checkout"
alias gckout="git checkout"
#alias go="git push -u origin"
alias gsh='git stash'
alias gw='git whatchanged'
alias gitlg="git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"
# https://github.com/caarlos0/svu?tab=readme-ov-file#creating-tags
alias gtn='git tag $(svu next)'

alias cat='bat -p'
alias macos-darkmode='osascript -e "tell application \"System Events\" to tell appearance preferences to set dark mode to true"'
alias macos-lightmode='osascript -e "tell application \"System Events\" to tell appearance preferences to set dark mode to false"'
# add ssh key to something, don't need to re-auth ssh key each time
# alias sshkey='ssh-add -K ~/.ssh/id_rsa'

# mac ssh agent woes
# alias killssh='killall ssh-agent; killall ssh; ssh-add -K ~/.ssh/id_rsa'

# study ckad
#alias studyckad="open -a Firefox 'https://www.udemy.com/course/certified-kubernetes-application-developer/learn' && code ~/github/private_notes/ckad"
#alias studygo="open -a Firefox 'https://quii.gitbook.io/learn-go-with-tests/' && code --new-window"

# vscode
# https://github.com/microsoft/vscode/issues/193188#issuecomment-1965664266
#alias code="code --disable-gpu --disable-software-rasterizer"

# kube
alias k='kubectl'
alias kctx='kubectx'
alias kns='kubens'

# 1Password SSH Auth Sock
export SSH_AUTH_SOCK=~/.1password/agent.sock
# https://github.com/gravitational/teleport/issues/22326#issue-1601647601
export TELEPORT_ADD_KEYS_TO_AGENT=no

# kubectl auto complete
if command -v kubectl >/dev/null 2>&1; then
  source <(kubectl completion zsh)
fi

### ENVIRONMENT VARS ###

export KUBE_EDITOR=/usr/bin/vim
if [ -d "$HOME/.kube/config.d" ]; then
  KUBECONFIG_FILES=("$HOME"/.kube/config.d/*(N))
  if (( ${#KUBECONFIG_FILES[@]} > 0 )); then
    export KUBECONFIG="${(j/:/)KUBECONFIG_FILES}"
  fi
fi
export VISUAL=/usr/bin/vim
export EDITOR=$VISUAL

# rust PATH
export PATH="$HOME/.cargo/bin:$PATH"
# pip PATH
export PATH="$HOME/.local/bin:$PATH"
# path for krew
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
# kind using podman
KIND_EXPERIMENTAL_PROVIDER=podman

ip-info(){
    curl -s ipinfo.io/$1 | jq
}

# dbennet kitchen stuff

# Python Virtualenvwrapper
export WORKON_HOME=${HOME}/.virtualenvs
export PROJECT_HOME=${HOME}/Development/
if [ -f /usr/share/virtualenvwrapper/virtualenvwrapper.sh ]; then
  source /usr/share/virtualenvwrapper/virtualenvwrapper.sh
fi
# User Ruby Path
export GEM_HOME="${HOME}/.gem/ruby/$(ruby --version | sed -E 's/^.* ([0-9]+\.[0-9]+)\..*$/\1.0/')"
export PATH=${PATH}:${GEM_HOME}/bin

# loki certs
#
export LOKI_CLIENT_CERT_PATH="${HOME}/.certs/${USER}.crt"
export LOKI_CLIENT_KEY_PATH="${HOME}/.certs/${USER}.key"


# salt
export SALT_KITCHEN_DRIVER="vagrant"
export KITCHEN_DRIVER_NAME="vagrant"

# go env path
export PATH="$PATH:$HOME/go/bin"

# fix term colors for tmux
# https://unix.stackexchange.com/questions/1045/getting-256-colors-to-work-in-tmux
export TERM=xterm-256color

# put tokens in ~/.secrets/tokens
[ -f "$HOME/.secrets/tokens" ] && source "$HOME/.secrets/tokens"

# local-only work config
[ -f ~/.zshrc.work ] && source ~/.zshrc.work

if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook zsh)"
fi

# Chezmoi reminder: show unapplied/unsaved changes before each prompt.
if command -v chezmoi >/dev/null 2>&1; then
  autoload -Uz add-zsh-hook
  cz-changed() {
    local line state rel target

    while IFS= read -r line; do
      [[ -z "$line" ]] && continue
      state="$(printf '%s' "$line" | cut -c1-2)"
      rel="$(printf '%s' "$line" | cut -c4-)"
      [[ -z "$rel" ]] && continue

      target="$(chezmoi target-path -- "$rel" 2>/dev/null || printf '%s' "$HOME/$rel")"
      printf '%s %s\n' "$state" "$target"
    done < <(chezmoi status "$@")
  }
  cz-unmanaged() { chezmoi unmanaged -p relative "$@"; }
  chezmoi_reminder_precmd() {
    local changed
    changed="$(chezmoi status 2>/dev/null | wc -l | awk '{print $1}')"
    [[ -n "$changed" ]] || changed="0"
    [[ "$changed" == "0" ]] && return
    print -P "%F{173}%B${changed} changed dotfiles (review: cz-changed; apply: chezmoi apply)%b%f"
  }
  add-zsh-hook precmd chezmoi_reminder_precmd
fi

### MISC CONFIGS ###

# https://unix.stackexchange.com/questions/212127/zsh-disable-file-exists-warning-with-redirection
setopt clobber

# https://github.com/junegunn/fzf.vim/issues/1125
zle-line-init() {
    #zle -K viins # initiate `vi insert` as keymap (can be removed if `bindkey -V` has been set elsewhere)
    echo -ne "\e[5 q"
}

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
#NSS_DEFAULT_DB_TYPE sql
export PATH="$HOME/.rbenv/bin:$PATH"
if command -v rbenv >/dev/null 2>&1; then
  eval "$(rbenv init -)"
fi
if command -v mise >/dev/null 2>&1; then
  eval "$(mise activate zsh 2>/dev/null)"
fi

if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then . "$HOME/.nix-profile/etc/profile.d/nix.sh"; fi # added by Nix installer

# opencode
export PATH="$HOME/.opencode/bin:$PATH"

# Added by LM Studio CLI (lms)
export PATH="$PATH:$HOME/.lmstudio/bin"
# End of LM Studio CLI section
